<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Era Radio Filter</title>
    <style>
        :root {
            --bg-primary: #2d2418;
            --bg-secondary: #3d3425;
            --bg-tertiary: #4d4435;
            --text-primary: #e8dcc8;
            --text-secondary: #c4b8a4;
            --accent: #c4956a;
            --accent-hover: #d4a57a;
            --border: #5d5445;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--accent);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            margin-bottom: 30px;
            font-style: italic;
        }

        .panel {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .panel-title {
            font-size: 1.2rem;
            color: var(--accent);
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        /* Upload Section */
        .upload-area {
            border: 3px dashed var(--border);
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--bg-tertiary);
        }

        .upload-area:hover, .upload-area.dragover {
            border-color: var(--accent);
            background: rgba(196, 149, 106, 0.1);
        }

        .upload-area input {
            display: none;
        }

        .upload-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: var(--bg-primary);
            border-radius: 5px;
            display: none;
        }

        .file-info.visible {
            display: block;
        }

        /* Era Selector */
        .era-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
        }

        .era-btn {
            padding: 12px 20px;
            border: 2px solid var(--border);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            font-size: 1rem;
        }

        .era-btn:hover {
            border-color: var(--accent);
            background: rgba(196, 149, 106, 0.2);
        }

        .era-btn.active {
            background: var(--accent);
            color: var(--bg-primary);
            border-color: var(--accent);
        }

        .era-description {
            text-align: center;
            margin-top: 15px;
            font-style: italic;
            color: var(--text-secondary);
            min-height: 20px;
        }

        /* Sliders */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 25px;
        }

        .control-group {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .control-name {
            font-weight: bold;
        }

        .control-value {
            color: var(--accent);
            font-weight: bold;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: var(--bg-primary);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 2px solid var(--text-primary);
        }

        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: 2px solid var(--text-primary);
        }

        /* Playback Controls */
        .playback-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 600px) {
            .playback-section {
                grid-template-columns: 1fr;
            }
        }

        .playback-box {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .playback-label {
            margin-bottom: 15px;
            font-weight: bold;
            color: var(--accent);
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            font-size: 1rem;
            transition: all 0.2s ease;
            margin: 5px;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg-primary);
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover:not(:disabled) {
            border-color: var(--accent);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Download Section */
        .download-section {
            text-align: center;
        }

        .format-select {
            padding: 10px 15px;
            font-size: 1rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            margin-right: 10px;
            font-family: inherit;
        }

        /* Processing Indicator */
        .processing {
            display: none;
            text-align: center;
            padding: 20px;
            color: var(--accent);
        }

        .processing.visible {
            display: block;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .footer {
            text-align: center;
            margin-top: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Era Radio Filter</h1>
        <p class="subtitle">Transform your audio to sound like it's from a different era</p>

        <!-- Upload Section -->
        <div class="panel">
            <h2 class="panel-title">Upload Audio</h2>
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">&#127926;</div>
                <p>Drop an audio file here or click to browse</p>
                <p style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 10px;">
                    Supports MP3, WAV, OGG, FLAC
                </p>
                <input type="file" id="fileInput" accept="audio/*">
            </div>
            <div class="file-info" id="fileInfo">
                <strong>Loaded:</strong> <span id="fileName"></span>
            </div>
        </div>

        <!-- Era Selector -->
        <div class="panel">
            <h2 class="panel-title">Select Era</h2>
            <div class="era-buttons" id="eraButtons">
                <button class="era-btn" data-era="1910s">1910s</button>
                <button class="era-btn" data-era="1920s">1920s</button>
                <button class="era-btn" data-era="1930s">1930s</button>
                <button class="era-btn" data-era="1940s">1940s</button>
                <button class="era-btn active" data-era="1950s">1950s</button>
                <button class="era-btn" data-era="1960s">1960s</button>
                <button class="era-btn" data-era="1970s">1970s</button>
                <button class="era-btn" data-era="1980s">1980s</button>
            </div>
            <p class="era-description" id="eraDescription">Early rock & roll, jukeboxes</p>
        </div>

        <!-- Controls -->
        <div class="panel">
            <h2 class="panel-title">Adjust Parameters</h2>
            <div class="controls-grid">
                <div class="control-group">
                    <div class="control-label">
                        <span class="control-name">Compression</span>
                        <span class="control-value" id="compressionValue">70%</span>
                    </div>
                    <input type="range" id="compression" min="0" max="100" value="70">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span class="control-name">Record Hiss/Noise</span>
                        <span class="control-value" id="hissValue">35%</span>
                    </div>
                    <input type="range" id="hiss" min="0" max="100" value="35">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span class="control-name">Filtering</span>
                        <span class="control-value" id="filteringValue">65%</span>
                    </div>
                    <input type="range" id="filtering" min="0" max="100" value="65">
                </div>
                <div class="control-group">
                    <div class="control-label">
                        <span class="control-name">Mono Blend</span>
                        <span class="control-value" id="monoValue">75%</span>
                    </div>
                    <input type="range" id="mono" min="0" max="100" value="75">
                </div>
            </div>
        </div>

        <!-- Playback Controls -->
        <div class="panel">
            <h2 class="panel-title">Playback</h2>
            <div class="playback-section">
                <div class="playback-box">
                    <p class="playback-label">Original Audio</p>
                    <button class="btn btn-secondary" id="playOriginal" disabled>Play Original</button>
                </div>
                <div class="playback-box">
                    <p class="playback-label">Processed Audio</p>
                    <button class="btn btn-primary" id="playProcessed" disabled>Play Processed</button>
                </div>
            </div>
            <div class="processing" id="processing">
                <span class="spinner"></span>
                Processing audio...
            </div>
        </div>

        <!-- Download Section -->
        <div class="panel">
            <h2 class="panel-title">Download</h2>
            <div class="download-section">
                <select class="format-select" id="formatSelect">
                    <option value="wav">WAV (Lossless)</option>
                    <option value="mp3">MP3 (Compressed)</option>
                </select>
                <button class="btn btn-primary" id="downloadBtn" disabled>Download Processed Audio</button>
            </div>
        </div>

        <p class="footer">Era Radio Filter - Transform your audio through time</p>
    </div>

    <script>
        // Era presets configuration
        const ERA_PRESETS = {
            '1910s': {
                compression: 100,
                hiss: 90,
                filtering: 100,
                mono: 100,
                lowFreq: 500,
                highFreq: 2500,
                description: 'Spark gap era, extremely primitive, barely intelligible'
            },
            '1920s': {
                compression: 95,
                hiss: 80,
                filtering: 95,
                mono: 100,
                lowFreq: 400,
                highFreq: 2800,
                description: 'Crystal radio era, AM broadcast beginnings'
            },
            '1930s': {
                compression: 90,
                hiss: 70,
                filtering: 90,
                mono: 100,
                lowFreq: 300,
                highFreq: 3000,
                description: 'AM radio, lo-fi, scratchy'
            },
            '1940s': {
                compression: 80,
                hiss: 50,
                filtering: 85,
                mono: 100,
                lowFreq: 250,
                highFreq: 3500,
                description: 'War-era radio, slightly clearer'
            },
            '1950s': {
                compression: 70,
                hiss: 35,
                filtering: 65,
                mono: 75,
                lowFreq: 200,
                highFreq: 5000,
                description: 'Early rock & roll, jukeboxes'
            },
            '1960s': {
                compression: 50,
                hiss: 20,
                filtering: 45,
                mono: 50,
                lowFreq: 150,
                highFreq: 8000,
                description: 'FM emergence, cleaner but warm'
            },
            '1970s': {
                compression: 30,
                hiss: 10,
                filtering: 25,
                mono: 0,
                lowFreq: 100,
                highFreq: 10000,
                description: 'Near hi-fi, slight warmth/saturation'
            },
            '1980s': {
                compression: 20,
                hiss: 5,
                filtering: 15,
                mono: 0,
                lowFreq: 80,
                highFreq: 12000,
                description: 'FM dominance, clean, modern warmth'
            }
        };

        // State
        let audioContext = null;
        let originalBuffer = null;
        let processedBuffer = null;
        let currentSource = null;
        let isPlaying = false;
        let currentEra = '1950s';

        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const eraButtons = document.querySelectorAll('.era-btn');
        const eraDescription = document.getElementById('eraDescription');
        const compressionSlider = document.getElementById('compression');
        const hissSlider = document.getElementById('hiss');
        const filteringSlider = document.getElementById('filtering');
        const monoSlider = document.getElementById('mono');
        const compressionValue = document.getElementById('compressionValue');
        const hissValue = document.getElementById('hissValue');
        const filteringValue = document.getElementById('filteringValue');
        const monoValue = document.getElementById('monoValue');
        const playOriginalBtn = document.getElementById('playOriginal');
        const playProcessedBtn = document.getElementById('playProcessed');
        const downloadBtn = document.getElementById('downloadBtn');
        const formatSelect = document.getElementById('formatSelect');
        const processing = document.getElementById('processing');

        // Initialize audio context
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            return audioContext;
        }

        // File upload handlers
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('audio/')) {
                handleFile(file);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) {
                handleFile(e.target.files[0]);
            }
        });

        async function handleFile(file) {
            initAudioContext();
            fileName.textContent = file.name;
            fileInfo.classList.add('visible');

            const arrayBuffer = await file.arrayBuffer();
            originalBuffer = await audioContext.decodeAudioData(arrayBuffer);

            playOriginalBtn.disabled = false;
            await processAudio();
        }

        // Era selection
        eraButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                eraButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentEra = btn.dataset.era;
                applyPreset(currentEra);
            });
        });

        function applyPreset(era) {
            const preset = ERA_PRESETS[era];
            compressionSlider.value = preset.compression;
            hissSlider.value = preset.hiss;
            filteringSlider.value = preset.filtering;
            monoSlider.value = preset.mono;
            updateSliderDisplays();
            eraDescription.textContent = preset.description;

            if (originalBuffer) {
                processAudio();
            }
        }

        function updateSliderDisplays() {
            compressionValue.textContent = compressionSlider.value + '%';
            hissValue.textContent = hissSlider.value + '%';
            filteringValue.textContent = filteringSlider.value + '%';
            monoValue.textContent = monoSlider.value + '%';
        }

        // Slider event listeners
        [compressionSlider, hissSlider, filteringSlider, monoSlider].forEach(slider => {
            slider.addEventListener('input', () => {
                updateSliderDisplays();
            });
            slider.addEventListener('change', () => {
                if (originalBuffer) {
                    processAudio();
                }
            });
        });

        // Audio processing
        async function processAudio() {
            if (!originalBuffer) return;

            processing.classList.add('visible');
            playProcessedBtn.disabled = true;
            downloadBtn.disabled = true;

            // Process in next frame to allow UI update
            await new Promise(resolve => setTimeout(resolve, 50));

            try {
                const preset = ERA_PRESETS[currentEra];
                const filterAmount = filteringSlider.value / 100;
                const monoAmount = monoSlider.value / 100;
                const hissAmount = hissSlider.value / 100;
                const compAmount = compressionSlider.value / 100;

                // Calculate filter frequencies based on preset and slider
                const fullLow = 20;
                const fullHigh = 20000;
                const lowFreq = fullLow + (preset.lowFreq - fullLow) * filterAmount;
                const highFreq = fullHigh - (fullHigh - preset.highFreq) * filterAmount;

                // Create offline context for processing
                const offlineCtx = new OfflineAudioContext(
                    originalBuffer.numberOfChannels,
                    originalBuffer.length,
                    originalBuffer.sampleRate
                );

                // Source
                const source = offlineCtx.createBufferSource();
                source.buffer = originalBuffer;

                // Mono conversion
                let currentNode = source;
                if (monoAmount > 0 && originalBuffer.numberOfChannels > 1) {
                    // Create mono mix using channel merger/splitter
                    const splitter = offlineCtx.createChannelSplitter(2);
                    const merger = offlineCtx.createChannelMerger(2);
                    const leftGain = offlineCtx.createGain();
                    const rightGain = offlineCtx.createGain();
                    const monoGain = offlineCtx.createGain();

                    // Mix stereo based on mono amount
                    const stereoMix = 1 - monoAmount;

                    currentNode.connect(splitter);
                    splitter.connect(leftGain, 0);
                    splitter.connect(rightGain, 1);
                    splitter.connect(monoGain, 0);
                    splitter.connect(monoGain, 1);

                    monoGain.gain.value = 0.5 * monoAmount;
                    leftGain.gain.value = stereoMix;
                    rightGain.gain.value = stereoMix;

                    leftGain.connect(merger, 0, 0);
                    rightGain.connect(merger, 0, 1);
                    monoGain.connect(merger, 0, 0);
                    monoGain.connect(merger, 0, 1);

                    currentNode = merger;
                }

                // High-pass filter
                const highPass = offlineCtx.createBiquadFilter();
                highPass.type = 'highpass';
                highPass.frequency.value = lowFreq;
                highPass.Q.value = 0.7;
                currentNode.connect(highPass);
                currentNode = highPass;

                // Low-pass filter
                const lowPass = offlineCtx.createBiquadFilter();
                lowPass.type = 'lowpass';
                lowPass.frequency.value = highFreq;
                lowPass.Q.value = 0.7;
                currentNode.connect(lowPass);
                currentNode = lowPass;

                // Compressor
                const compressor = offlineCtx.createDynamicsCompressor();
                compressor.threshold.value = -50 + (1 - compAmount) * 40; // -50 to -10 dB
                compressor.knee.value = 40 * compAmount;
                compressor.ratio.value = 1 + compAmount * 19; // 1 to 20
                compressor.attack.value = 0.003;
                compressor.release.value = 0.25;
                currentNode.connect(compressor);
                currentNode = compressor;

                // Add some saturation/warmth for older eras via waveshaper
                if (compAmount > 0.3) {
                    const waveshaper = offlineCtx.createWaveShaper();
                    waveshaper.curve = makeDistortionCurve(compAmount * 20);
                    waveshaper.oversample = '2x';
                    currentNode.connect(waveshaper);
                    currentNode = waveshaper;
                }

                // Main gain
                const mainGain = offlineCtx.createGain();
                mainGain.gain.value = 0.8;
                currentNode.connect(mainGain);
                currentNode = mainGain;

                // Mix with noise
                const mixGain = offlineCtx.createGain();
                currentNode.connect(mixGain);

                if (hissAmount > 0) {
                    const noiseBuffer = createNoiseBuffer(offlineCtx, originalBuffer.length, hissAmount, preset);
                    const noiseSource = offlineCtx.createBufferSource();
                    noiseSource.buffer = noiseBuffer;

                    const noiseGain = offlineCtx.createGain();
                    noiseGain.gain.value = hissAmount * 0.15;

                    // Filter noise for more realistic sound
                    const noiseFilter = offlineCtx.createBiquadFilter();
                    noiseFilter.type = 'bandpass';
                    noiseFilter.frequency.value = (lowFreq + highFreq) / 2;
                    noiseFilter.Q.value = 0.5;

                    noiseSource.connect(noiseFilter);
                    noiseFilter.connect(noiseGain);
                    noiseGain.connect(mixGain);
                    noiseSource.start();
                }

                mixGain.connect(offlineCtx.destination);
                source.start();

                processedBuffer = await offlineCtx.startRendering();

                playProcessedBtn.disabled = false;
                downloadBtn.disabled = false;
            } catch (error) {
                console.error('Error processing audio:', error);
            } finally {
                processing.classList.remove('visible');
            }
        }

        function makeDistortionCurve(amount) {
            const samples = 44100;
            const curve = new Float32Array(samples);
            const deg = Math.PI / 180;

            for (let i = 0; i < samples; i++) {
                const x = (i * 2) / samples - 1;
                curve[i] = ((3 + amount) * x * 20 * deg) / (Math.PI + amount * Math.abs(x));
            }
            return curve;
        }

        function createNoiseBuffer(ctx, length, amount, preset) {
            const buffer = ctx.createBuffer(2, length, ctx.sampleRate);
            const era = parseInt(currentEra);

            for (let channel = 0; channel < buffer.numberOfChannels; channel++) {
                const data = buffer.getChannelData(channel);
                let lastValue = 0;

                for (let i = 0; i < length; i++) {
                    // Mix white and pink noise
                    const white = Math.random() * 2 - 1;

                    // Simple pink noise approximation
                    lastValue = lastValue * 0.99 + white * 0.01;
                    const pink = lastValue * 10;

                    // Blend based on era (older = more crackle)
                    const crackleChance = era < 1940 ? 0.0005 * amount : 0.0001 * amount;
                    const crackle = Math.random() < crackleChance ? (Math.random() - 0.5) * 2 : 0;

                    // Mix noise types
                    data[i] = (white * 0.3 + pink * 0.7) * amount + crackle;
                }
            }
            return buffer;
        }

        // Playback controls
        playOriginalBtn.addEventListener('click', () => togglePlayback('original'));
        playProcessedBtn.addEventListener('click', () => togglePlayback('processed'));

        function togglePlayback(type) {
            initAudioContext();

            if (currentSource) {
                currentSource.stop();
                currentSource = null;
                playOriginalBtn.textContent = 'Play Original';
                playProcessedBtn.textContent = 'Play Processed';
            }

            const buffer = type === 'original' ? originalBuffer : processedBuffer;
            if (!buffer) return;

            currentSource = audioContext.createBufferSource();
            currentSource.buffer = buffer;
            currentSource.connect(audioContext.destination);
            currentSource.start();

            const btn = type === 'original' ? playOriginalBtn : playProcessedBtn;
            btn.textContent = 'Stop';

            currentSource.onended = () => {
                currentSource = null;
                playOriginalBtn.textContent = 'Play Original';
                playProcessedBtn.textContent = 'Play Processed';
            };
        }

        // Download
        downloadBtn.addEventListener('click', async () => {
            if (!processedBuffer) return;

            const format = formatSelect.value;

            if (format === 'wav') {
                downloadWav();
            } else {
                // For MP3, we'll use WAV as fallback since MP3 encoding requires external library
                downloadWav();
                alert('Note: MP3 encoding requires external libraries. Downloading as WAV instead.');
            }
        });

        function downloadWav() {
            const wav = audioBufferToWav(processedBuffer);
            const blob = new Blob([wav], { type: 'audio/wav' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `processed_${currentEra}_audio.wav`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function audioBufferToWav(buffer) {
            const numChannels = buffer.numberOfChannels;
            const sampleRate = buffer.sampleRate;
            const format = 1; // PCM
            const bitDepth = 16;

            const bytesPerSample = bitDepth / 8;
            const blockAlign = numChannels * bytesPerSample;

            const dataLength = buffer.length * blockAlign;
            const headerLength = 44;
            const totalLength = headerLength + dataLength;

            const arrayBuffer = new ArrayBuffer(totalLength);
            const view = new DataView(arrayBuffer);

            // WAV header
            writeString(view, 0, 'RIFF');
            view.setUint32(4, totalLength - 8, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); // fmt chunk size
            view.setUint16(20, format, true);
            view.setUint16(22, numChannels, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * blockAlign, true);
            view.setUint16(32, blockAlign, true);
            view.setUint16(34, bitDepth, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);

            // Audio data
            const channels = [];
            for (let i = 0; i < numChannels; i++) {
                channels.push(buffer.getChannelData(i));
            }

            let offset = 44;
            for (let i = 0; i < buffer.length; i++) {
                for (let channel = 0; channel < numChannels; channel++) {
                    const sample = Math.max(-1, Math.min(1, channels[channel][i]));
                    const intSample = sample < 0 ? sample * 0x8000 : sample * 0x7FFF;
                    view.setInt16(offset, intSample, true);
                    offset += 2;
                }
            }

            return arrayBuffer;
        }

        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        // Initialize with default era
        applyPreset(currentEra);
    </script>
</body>
</html>
